# 四、接口测试及工具类

 ## 什么是接口测试
 
   - 在说接口测试之前，我们先来搞清楚这两个概念，前端和后端。
   - 前端是什么呢，对于web端来说，咱们使用的网页，打开的网站，这都是前端，这些都是html、css写的；对于app端来说呢，它就是咱们用的app，android或者object-C（开发ios上的app）开发的，它的作用就是显示页面，让我们看到漂亮的页面，以及做一些简单的校验，比如说非空校验，咱们在页面上操作的时候，这些业务逻辑、功能，比如说你购物，发微博这些功能是由后端来实现的，后端去控制你购物的时候扣你的余额，发微博发到哪个账号下面，那前端和后端是怎么交互的呢，就是通过接口。
   - 前面说的你可能不好理解，你只需记住：前端负责貌美如花，后端负责挣钱养家。
   
   - 接口一般来说有两种，一种是程序内部的接口，一种是系统对外的接口。
   - 系统对外的接口：比如你要从别的网站或服务器上获取资源或信息，别人肯定不会把数据库共享给你，他只能给你提供一个他们写好的方法来获取数据，你引用他提供的接口就能使用他写好的方法，从而达到数据共享的目的，比如说咱们用的app、网址这些它在进行数据处理的时候都是通过接口来进行调用的。
   - 程序内部的接口：方法与方法之间，模块与模块之间的交互，程序内部抛出的接口，比如bbs系统，有登录模块、发帖模块等等，那你要发帖就必须先登录，要发帖就得登录，那么这两个模块就得有交互，它就会抛出一个接口，供内部系统进行调用。
   - 接口测试是测试系统组件间接口的一种测试。接口测试主要用于检测外部系统与系统之间以及内部各个子系统之间的交互点。测试的重点是要检查数据的交换，传递和控制管理过程，以及系统间的相互逻辑依赖关系等。
***
 ## 常见接口：
   
   - webService接口：是走soap协议通过http传输，请求报文和返回报文都是xml格式的，我们在测试的时候都用通过工具才能进行调用，测试。可以使用的工具有SoapUI、jmeter、loadrunner等；  
   - http api接口：是走http协议，通过路径来区分调用的方法，请求报文都是key-value形式的，返回报文一般都是json串，有get和post等方法，这也是最常用的两种请求方式。可以使用的工具有postman、RESTClient、jmeter、loadrunner等；
***
 ## 接口组成

   - 首先，接口文档应该包含以下内容：
   
     - 1、接口说明
     - 2、调用url
     - 3、请求方法（get\post）
     - 4、请求参数、参数类型、请求参数说明
     - 5、返回参数说明

   - 由接口文档可知，接口至少应有请求地址、请求方法、请求参数（入参和出参）组成，部分接口有请求头header。
   - 标头 (header)：是服务器以HTTP协议传HTML资料到浏览器前所送出的字串，在标头与 HTML 文件之间尚需空一行分隔，一般存放cookie、token等信息
   - 有同学问我header和入参有什么关系？它们不都是发送到服务器的参数吗？
   - OK，首先，它们确实都是发送到服务器里的参数，但它们是有区别的，header里存放的参数一般存放的是一些校验信息，比如cookie，它是为了校验这个请求是否有权限请求服务器，如果有，它才能请求服务器，然后把请求地址连同入参一起发送到服务器，然后服务器会根据地址和入参来返回出参。也就是说，服务器是先接受header信息进行判断该请求是否有权限请求，判断有权限后，才会接受请求地址和入参的。
***
 ## 为什么要做接口测试：
    
   - 大家都知道，接口其实就是前端页面或APP等调用与后端做交互用的，所以好多人都会问，我功能测试都测好了，为什么还要测接口呢？OK，在回答这个问题之前，先举个栗子：
   - 比如测试用户注册功能，规定用户名为6~18个字符，包含字母（区分大小写）、数字、下划线。首先功能测试时肯定会对用户名规则进行测试时，比如输入20个字符、输入特殊字符等，但这些可能只是在前端做了校验，后端可能没做校验，如果有人通过抓包绕过前端校验直接发送到后端怎么办呢？试想一下，如果用户名和密码未在后端做校验，而有人又绕过前端校验的话，那用户名和密码不就可以随便输了吗？如果是登录可能会通过SQL注入等手段来随意登录，甚至可以获取管理员权限，那这样不是很恐怖？
   - 所以，接口测试的必要性就体现出来了：  
     - 1、可以发现很多在页面上操作发现不了的bug  
     - 2、检查系统的异常处理能力  
     - 3、检查系统的安全性、稳定性  
     - 4、前端随便变，接口测好了，后端不用变  
***
 ## 接口测试怎么测：  
    
   在进行接口测试前，还需要了解：  
    
   - GET和POST请求： 
    
   如果是get请求的话，直接在浏览器里输入就行了，只要在浏览器里面直接能请求到的，都是get请求，如果是post的请求的话，就不行了，就得借助工具来发送。  
   
   - GET请求和POST请求的区别：  

     - 1、GET使用URL或Cookie传参。而POST将数据放在BODY中。  
     - 2、GET的URL会有长度上的限制，则POST的数据则可以非常大。  
     - 3、POST比GET安全，因为数据在地址栏上不可见。  
     - 4、一般get请求用来获取数据，post请求用来发送数据。  
    其实上面这几点，只有最后一点说的是比较靠谱的，第一点post请求也可以把数据放到url里面，get请求其实也没长度限制，post请求看起来参数是隐式的，稍微安全那么一些些，但是那只是对于小白用户来说的，就算post请求，你通过抓包也是可以抓到参数的。所以上面这些面试的时候你说出来就行了。  
    
   - http状态码  
    
    每发出一个http请求之后，都会有一个响应，http本身会有一个状态码，来标示这个请求是否成功，常见的状态码有以下几种：  
    1、200 2开头的都表示这个请求发送成功，最常见的就是200，就代表这个请求是ok的，服务器也返回了。  
    2、300 3开头的代表重定向，最常见的是302，把这个请求重定向到别的地方了，  
    3、400 400代表客户端发送的请求有语法错误，401代表访问的页面没有授权，403表示没有权限访问这个页面，404代表没有这个页面  
    4、500 5开头的代表服务器有异常，500代表服务器内部异常，504代表服务器端超时，没返回结果  
    
   - 接下来再说接口测试怎么测：
    
    1）、通用接口用例设计
    
     ①、通过性验证：首先肯定要保证这个接口功能是好使的，也就是正常的通过性测试，按照接口文档上的参数，正常传入，是否可以返回正确的结果。  
     ②、参数组合：现在有一个操作商品的接口，有个字段type，传1的时候代表修改商品，商品id、商品名称、价格有一个是必传的，type传2的时候是删除商品，商品id　　是必传的，这样的，就要测参数组合了，type传1的时候，只传商品名称能不能修改成功，id、名称、价格都传的时候能不能修改成功。  
     ③、接口安全：   
      1、绕过验证，比如说购买了一个商品，它的价格是300元，那我在提交订单时候，我把这个商品的价格改成3元，后端有没有做验证，更狠点，我把钱改成-3，是不是我的余额还要增加？  
      2、绕过身份授权，比如说修改商品信息接口，那必须得是卖家才能修改，那我传一个普通用户，能不能修改成功，我传一个其他的卖家能不能修改成功   
      3、参数是否加密，比如说我登陆的接口，用户名和密码是不是加密，如果不加密的话，别人拦截到你的请求，就能获取到你的信息了，加密规则是否容易破解。   
      4、密码安全规则，密码的复杂程度校验
    
     ④、异常验证：
    　　所谓异常验证，也就是我不按照你接口文档上的要求输入参数，来验证接口对异常情况的校验。比如说必填的参数不填，输入整数类型的，传入字符串类型，长度是10的，传11，总之就是你说怎么来，我就不怎么来，其实也就这三种，必传非必传、参数类型、入参长度。  
    
    2）、根据业务逻辑来设计用例  
    　　根据业务逻辑来设计的话，就是根据自己系统的业务来设计用例，这个每个公司的业务不一样，就得具体的看自己公司的业务了，其实这也和功能测试设计用例是一样的。  
        　　举个例子，拿bbs来说，bbs的需求是这样的：  
      　　  1、登录失败5次，就需要等待15分钟之后再登录  
      　　  2、新注册的用户需要过了实习期才能发帖  
       　　 3、删除帖子扣除积分  
       　　 4、......  
       　　像这样的你就要把这些测试点列出来，然后再去造数据测试对应的测试点。  
***
 
 ## Postman
  
  Postman是谷歌的一款接口测试插件，它使用简单，支持用例管理，支持get、post、文件上传、响应验证、变量管理、环境参数管理等功能，可以批量运行，并支持用例导出、导入。

***

 ## [Jmeter](https://blog.csdn.net/github_27109687/article/details/71968662)
  
   jmeter是一款100%纯Java编写的免费开源的工具，它主要用来做接口+压力测试，相比loadrunner来说，它内存占用小，免费开源，轻巧方便、无需安装，越来越被大众所喜爱。
  
 - **Jmeter-下载安装：**  
   
   进入apache官网https://www.apache.org/dist/jmeter/binaries下载Windows版本JMeter；
     
 - **Jmeter-下载插件：** 
    
   进入下载插件网页：https://jmeter-plugins.org/install/Install/ 下载plugin-manager.jar 并放在jmeter的lib/ext文件夹下
   打开jmeter，打开选项菜单底部的plugins-manager
   选择Available Plugins -勾选jpgc -standard set -右下角勾选apply changes and restart jmeter 安装
   然后重新打开jmeter，就可以在监听器里添加使用了。
     
 - **Jmeter-设置中文界面：** 
    
   进入Jmeter的bin目录下，找到jmeter.properties文件,在37行后面添加“language=zh_CN”，保存之后再打开jmeter就永久变为中文环境了
   
 - **Jmeter-接口返回，出现乱码**  
   
   Jmeter在接口返回的时候，响应内容如果有中文可能会显示乱码，需添加后置处理器：BeanShell PostProcessor，输入“prev.setDataEncoding("utf-8");”，再次请求，响应结果中已经没有乱码了

 - **Jmeter-http接口脚本,一般分五个步骤:** 
      
    - 添加线程组   
    - 添加http请求   
    - 在http请求中写入接入url、路径、请求方式和参数   
    - 添加查看结果树   
    - 调用接口、查看返回值  
     
 - **Jmeter-中跟踪重定向和自动重定向区别**

    - 跟踪重定向通俗的理解就是跟踪请求执行的过程，并记录一些信息给开发者看到，我们一般可以在结果日志和监控中看到
    - 自动重定向是不用跟踪请求执行过程，也不用记录
    
 - **Jmeter-操作数据库**
 
    - 配置oracle数据库连接
       Database URL: jdbc:oracle:thin:@192.168.100.171:1521:test
       JDBC Driver class：oracle.jdbc.driver.OracleDriver
       Username：账号
       Password：密码
       
    - 配置mysql数据库连接
       Database URL: jdbc:mysql:// 数据库地址 /库名
       JDBC Driver class：com.mysql.jdbc.Driver
       Username：账号
       Password：密码
       
       注意：替换数据库IP地址、端口号、库名以及用户名、密码。
       
 - **Jmeter组件执行顺序与作用域**
 
    - *1、Jmeter重要组件：*  
      1) 配置元件---Config Element：  
　　   用于初始化默认值和变量，以便后续采样器使用。配置元件大其作用域的初始阶段处理，配置元件仅对其所在的测试树分支有效，如，在同一个作用域的任何采样器前。

      2) 前置处理器--- Pre Processors：  
　　   前置处理器会在采样器发出请求之前做一些特殊操作。如果前置处理器附着在某个采样器之下，那么它只会在该采样器运行之前执行。前置处理器通常用于在采样器发出请求前修改采样器的某些设置，或者更新某些变量的值（这些变量不在服务器响应中获取值）。

      3) 计时器---Timer：  
　　     定时器会让作用域内的每一个采样器都在执行前等待一个固定时长，如果不设定这种延迟，JMeter可能会在短时间内产生大量访问请求，导致服务器被大量请求所淹没。如果为线程组添加了多个定时器，那么JMeter会将这些定时器的时长叠加起来，共同影响作用域范围内的采样器。定时器可以作为采样器或者逻辑控制器的子项，目的是只影响作用域内的采样器。

      4) 采样器---sampler：  
　　     采样器告诉JMeter发送一个请求到指定服务器，并等待服务器的请求。采样器会按照其在测试树中的顺序去执行，还可以用逻辑控制器来改变采样器运行的重复次数。

      5) 后置处理器---Post Processors：  
　　     后置处理器会在采样器发出请求之后做一些特殊操作。如果后置处理器附着在某个采样器之下，那么它只会在该采样器运行之后执行。后置处理器通常被用来处理服务器的响应数据，特别是服务器响应中提取数据。

      6) 断言---Assertions：  
　　     用户可以使用断言来检查从服务器获得的响应内容。通过断言可以测试服务器返回的响应与测试人员的期望是否相符

      7) 监听器---Listener：  
　　     监听器提供了对JMeter在测试期间收集到的信息的访问方法。"图形结果"监听器会将系统响应时长绘制在一张图片之中。"查看结果树"监听器会展示采样器请求和响应的细节，还可以将测试数据导入到文件之中，以供后续分析。

      8) 逻辑控制器---Controller：  
　　     逻辑控制器可以帮助用户控制JMeter的测试逻辑，特别是何时发送请求。逻辑控制器可以改变其子测试元件的请求执行顺序。

    - *2、组件执行顺序：*

      测试计划的元素执行是有序的，通过以下方式执行：
       1–配置元件（Config Element）
       2–前置处理器（Pre Processors）
       3–定时器（Timer）
       4–取样器（sampler）
       5–后置处理器（Post Processors，只在有结果可用情况下执行）
       6–断言（Assertions，只在有结果可用情况下执行）
       7–监听器（Listener，只在有结果可用情况下执行）

    - *3、组件作用域：* 
     
      元件收集其作用范围的每一个sampler元件的信息并呈现，在jmeter中，元件的作用域是靠测试计划的的树型结构中元件的父子关系来确定的，作用域的原则是： 
     
      采样器（sampler）：元件不和其它元件相互作用，因此不存在作用域的问题。  
      逻辑控制器（Logic Controller）：元件只对其子节点中的取样器 和 逻辑控制器作用。  
      除采样器 和 逻辑控制器 元件外，其他6类元件，如果是某个sampler的子节点，则该元件只对其父子节点起作用。  
      除采样器和逻辑控制器元件外的其他6类元件，如果其父节点不是sampler ，则其作用域是该元件父节点下的其他所有后代节点（包括子节点，子节点的子节点等）。
      
    - *4、特殊说明：*  

      配置元件（Config Elemnet）-->用户自定义变量组件（User Defined Variables）：这个组件不管放在哪个位置，它定义的变量都会被整个线程所共享。
   
    
 - **Jmeter-压力测试**
     - 压力测试分两种场景  
       第一种是单场景，压一个接口的；
       第二种是混合场景，多个有关联的接口。压测时间，一般场景都运行10-15分钟。如果是疲劳测试，可以压一天或一周，根据实际情况来定。

     - 压测任务需求的确认    
       压测前要明确压测功能和压测指标，一般需要确定的几个问题：
       固定接口参数进行压测还是进行接口参数随机化压测？
       要求支持多少并发数？
       TPS（每秒钟处理事务数）目标多少？响应时间要达到多少？
       压服务器名称还是压服务器IP，一般都是压测指定的服务器
     
     - 压测设置  
      线程数：并发数量，能跑多少量。具体说是一次存在多少用户同时访问
      Rame-Up Period(in seconds):表示JMeter每隔多少秒发动并发。理解成准备时长：设置虚拟用户数需要多长时间全部启动。如果线程数是20，准备时长为10，那么需要10秒钟启动20个数量，也就是每秒钟启动2个线程。
      循环次数：这个设置不会改变并发数，可以延长并发时间。总请求数=线程数*循环次数
      调度器：设置压测的启动时间、结束时间、持续时间和启动延迟时间。
     
     - 压测结果查看  
       运行完后，聚合报告会显示压测的结果。主要观察Samples、Average、error、Throughput。

       Samples:表示一共发出的请求数
       Average：平均响应时间，默认情况下是单个Request的平均响应时间（ms）
       Error%:测试出现的错误请求数量百分比。若出现错误就要看服务端的日志，配合开发查找定位原因
       Throughput:简称tps,吞吐量，默认情况下表示每秒处理的请求数，也就是指服务器处理能力，tps越高说明服务器处理能力越好。
     
     - 压测结果的分析  
       有错误率同开发确认，确定是否允许错误的发生或者错误率允许在多大的范围内；
 
       Throughput吞吐量每秒请求的数大于并发数，则可以慢慢的往上面增加；若在压测的机器性能很好的情况下，出现吞吐量小于并发数，说明并发数不能再增加了，可以慢慢的往下减，找到最佳的并发数；

       压测结束，·登陆相应的web服务器查看CPU等性能指标，进行数据的分析;

       最大的tps:不断的增加并发数，加到tps达到一定值开始出现下降，那么那个值就是最大的tps。

       最大的并发数：最大的并发数和最大的tps是不同的概率，一般不断增加并发数，达到一个值后，服务器出现请求超时，则可认为该值为最大的并发数。
       压测过程出现性能瓶颈，若压力机任务管理器查看到的cpu、网络和cpu都正常，未达到90%以上，则可以说明服务器有问题，压力机没有问题。
       影响性能考虑点包括：数据库、应用程序、中间件（tomact、Nginx）、网络和操作系统等方面。
 
     - jmeter在linux下进行压力测试  
     
       jmeter 在linux安装   
       简单说下，就是要先安装jdk,同时再配置环境变量，最后再上传jmeter压缩的安装包，在linux下解压完安装包就可以使用了。推荐博客：http://blog.csdn.net/zhemeteor/article/details/51315874

       jmeter在linux运行     
       进入jmeter下的bin目录下运行脚本，未配置jmeter环境变量的条件下，运行的命令：  

       ./jmeter -n -t a.jmx -l res.jtl

       其中a.jmx是准备好的jmeter脚本,res.jtl是测试结果文件，测试结果文件可以导入到jmeter察看结果树下查看。

    
    
 ## LoadRunner
   分为哪三个模块？请简述各模块的主要功能。
　　Virtual User Generator：用于录制脚步  
　　Mercury LoadRunner Controller：用于创建、运行和监控场景  
　　Mercury LoadRunner Analysis：用于分析测试结果  

